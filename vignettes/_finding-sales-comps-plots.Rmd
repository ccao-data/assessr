We can visualize the resulting comparables in a variety of ways. To see the trade-off caused by changing $l$, we choose a random subset of 5 comparables sets from the predicted data, then compare them for $l = 0.1$ and $l = 0.9$. These sets are shown in the table below. Each page of the table shows 1 comparables set, each of which includes 1 target property, 10 sales for $l = 0.1$ and 10 sales for $l = 0.9$.

```{r table, echo=FALSE, out.width='100%'}
# Create a datatable object showing each comparables set
comparables_small %>%
  select(-median_sp, Group = group, Type = type, Price = price, -lat, -lon) %>%
  filter(!(set == "l = 0.9" & Type == "Target")) %>%
  mutate(
    set = gsub("l = ", "", set),
    set = ifelse(Type == "Target", NA, set)
  ) %>%
  ccao::vars_rename(
    names_from = "socrata",
    names_to = "pretty",
    dict = ccao::vars_dict_legacy
  ) %>%
  vars_recode(type = "short") %>%
  arrange(Group, desc(Type), set) %>%
  rename("Tradeoff Value (l)" = set) %>%
  DT::datatable(
    rownames = FALSE,
    filter = "none",
    autoHideNavigation = TRUE,
    selection = "none",
    options = list(
      pageLength = 21,
      autoWidth = TRUE,
      scrollX = TRUE,
      searching = FALSE,
      info = FALSE
    )
  ) %>%
  DT::formatCurrency("Price", digits = 0) %>%
  DT::formatRound("Building Square Feet", digits = 0)
```

#### Sales comparables characteristics

Comparable properties should have similar characteristics. The plot below shows the percent of comparable characteristics that are within 10% of the corresponding value for the target property (or exactly matching, in the case of categorical variables). For example, if the target property in Group 1 has a finished basement, and 9 of its 10 comparables also have a finished basement, then the Group 1 value for `bsmt_fin` will be 90%.

Note that lowering the value of $l$ drastically increases the percentage match of many characteristics, particularly the ones which were more heavily weighted using `var_weights` in the initial clustering (`bldg_sf`, `age`, and `ext_wall`).

```{r tile, echo=FALSE, out.width='100%', message=FALSE}
# Create a tile plot of chars values
comparables_small %>%
  group_by(set, group) %>%
  summarize(
    across(bldg_sf:beds, function(x) (sum(between(x, first(x) - (first(x) * 0.1), first(x) + (first(x) * 0.1))) - 1) / (n() - 1)),
    across(air:gar1_size, function(x) sum(x == first(x)) - 1) / (n() - 1)
  ) %>%
  tidyr::pivot_longer(-c(set, group), names_to = "var", values_to = "per_match") %>%
  mutate(
    group = forcats::fct_reorder(group, rev(as.numeric(gsub("\\D+", "", group)))),
    var = factor(var, levels = names(comparables_small))
  ) %>%
ggplot() +
  geom_tile(aes(x = var, y = group, fill = per_match)) +
  geom_text(
    aes(
      x = var,
      y = group,
      label = scales::percent(per_match),
      color = per_match < 0.80
    ),
    alpha = 0.6,
    size = 2.8
  ) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), position = "bottom") +
  scale_fill_distiller(
    name = "Percent of comparable characteristics\nwithin 10% of target property's value*",
    direction = 1,
    labels = scales::percent,
    limits = c(0, 1)
  ) +
  scale_color_manual(
    values = c("TRUE" = "black", "FALSE" = "white"),
    guide = FALSE
  ) +
  labs(
    x = "", y = "",
    caption = "*Or exactly matching, for categorical variables"
    
  ) +
  guides(fill = guide_legend(title.position = "bottom")) +
  facet_wrap(vars(set), ncol = 2, strip.position = "top") +
  theme_minimal() +
  theme(
    plot.margin = margin(r = 14, l = -12),
    strip.text = element_text(size = 13, face = "bold"),
    legend.title = element_text(margin = margin(b = 6)),
    legend.position = "bottom",
    axis.text.x = element_text(angle = -45, hjust = 0),
    axis.ticks = element_blank()
  )
```

#### Sales comparables locations

Good comparables should also be nearby the target property. We can check the spatial distribution of our comparables sets by plotting them on a map of Evanston. Note that for $l = 0.1$ the properties are much more sparsely distributed. This may be appropriate for a small area such as Evanston, but might be less acceptable for a larger area such as an entire county. 

```{r map, echo=FALSE, out.width='100%', warning=FALSE}
comparables_small %>%
  st_as_sf(coords = c("lon", "lat"), crs = 3435) %>%
  st_transform(4326) %>%
  ggplot() +
  geom_sf(data = st_set_crs(ccao::nbhd_shp, 4326) %>% filter(township_name == "Evanston")) +
  geom_sf(aes(color = factor(group), shape = type, size = type)) +
  scale_shape_manual(name = "Type", values = c("Target" = 15, "Comp" = 10)) +
  scale_size_manual(name = "Type", values = c("Target" = 3, "Comp" = 2)) +
  guides(color = guide_legend(title = "Comparable groups")) +
  labs(caption = "*Sub-boundaries represent Cook County Assessor neighborhoods") +
  facet_wrap(vars(set), nrow = 1) +
  theme_void() +
  theme(strip.text = element_text(size = 13, face = "bold"))
```

#### Distributions of sale prices vs. fair market value

Finally, good comparables will be close to each other in price. Here we show distributions of sale prices for each comparables set, along with the last assessed value for each target property. The resulting distributions are quite wide for some properties, however, our clustering was done using just 10 variables. Adding further variables or choosing a higher $m$ value will likely result in tighter distributions.

```{r dist, echo=FALSE, out.width='100%', message=FALSE, warning=FALSE}
comparables_small %>%
  ggplot() +
  geom_histogram(aes(x = price, fill = type), binwidth = 5e4) +
  geom_vline(aes(xintercept = median_sp, color = "Median", linetype = "Median")) +
  scale_color_manual(name = "", values = c("Median" = "grey10")) +
  scale_linetype_manual(name = "", values = c("Median" = "dashed")) +
  scale_x_continuous(
    labels = scales::dollar,
    breaks = scales::breaks_extended(6)
  ) +
  scale_fill_manual(
    name = "Type",
    values = c("Comp" = "grey75", "Target" = "darkred")
  ) +
  facet_grid(rows = vars(group), cols = vars(set)) +
  labs(
    caption = "*Target property (red) price is most recent Fair Market Value",
    x = "Sale Price",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    strip.text.x = element_text(size = 13, face = "bold"),
    panel.grid.minor.y = element_blank(),
    panel.spacing.y = unit(0.5, "cm"),
    axis.ticks.x = element_line(size = 0.7),
    axis.text.x = element_text(margin = margin(b = 4, t = 2), angle = -45, hjust = 0),
    axis.text.y = element_text(margin = margin(l = 6))
  )
```