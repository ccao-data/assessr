<script>
function plot_switch(id1, id2) {
    var x = document.getElementById(id1);
    var y = document.getElementById(id2);
    if (x.style.display === "none") {
        x.style.display = "block";
        y.style.display = "none";
    } else {
        x.style.display = "none";
        y.style.display = "block";
    }
}

document.addEventListener("DOMContentLoaded", function() {
  plot_switch('map2', 'map1');
  plot_switch('tile2', 'tile1');
  plot_switch('table2', 'table1');
  plot_switch('dist2', 'dist1');
});
</script>

<style>
.toggle_button {
  color: #fff !important;
  text-transform: uppercase;
  text-decoration: none;
  font-weight: bold;
  background: #CD5C5C;
  padding: 10px;
  display: inline-block;
  border: none;
  width: 36%;
  margin-top: 2px;
  margin-bottom: 50px;
  margin-left: 32%;
  margin-right: 32%
}
</style>




<br>
<div id="map1">
#### Sales Comparables Locations in Evanston $(l = `r l`)$

Good comparables should be nearby the target property. We can check the spatial distribution of our comparables sets by plotting them on a map of Evanston. Note that for $l = 0.1$ the properties are much more sparsely distributed. This may be appropriate for a small area such as Evanston, but might be less acceptable for a larger area such as an entire county. 

```{r map1, echo=FALSE, out.width='100%', cache=FALSE, warning=FALSE}
comparables_small %>%
  st_as_sf(coords = c("lon", "lat"), crs = 3435) %>%
  st_transform(4326) %>%
  ggplot() +
  geom_sf(data = st_set_crs(ccao::nbhd_shp, 4326) %>% filter(township_name == "Evanston")) +
  geom_sf(aes(color = factor(group), shape = type, size = type)) +
  scale_shape_manual(name = "Type", values = c("Target" = 15, "Comp" = 10)) +
  scale_size_manual(name = "Type", values = c("Target" = 3, "Comp" = 2)) +
  guides(
    color = guide_legend(title = "Comparable Groups")
  ) +
  labs(caption = "Sub-boundaries represent Cook County Assessor neighborhoods") +
  theme_void()
```
</div>

<div id="map2">
```{r, include=FALSE}
l <- 0.1
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Sales Comparables Locations in Evanston $(l = `r l`)$

Good comparables should be nearby the target property. We can check the spatial distribution of our comparables sets by plotting them on a map of Evanston. Note that for $l = 0.1$ the properties are much more sparsely distributed. This may be appropriate for a small area such as Evanston, but might be less acceptable for a larger area such as an entire county.  

```{r map2, echo=FALSE, out.width='100%', ref.label="map1", message=FALSE, warning=FALSE}
```
</div>

<button class=toggle_button onclick="plot_switch('map1', 'map2')">Toggle Distance Trade-Off Parameter Value</button>




<div id="tile1">
```{r, include=FALSE}
l <- 0.9
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Sales Comparables Characteristics $(l = `r l`)$

However, comparable properties should also have similar characteristics. The plot below shows the percent of characteristics from each comparables set that matches the target property. Darker values mean a high percentage of comparable characteristics match their target.

```{r tile1, echo=FALSE, out.width='100%', message=FALSE, cache=FALSE}
# Create a tile plot of chars values
comparables_small %>%
  group_by(group) %>%
  summarize(
    across(rooms:gar1_size, function(x) sum(x == first(x)) - 1) / (n() - 1)
  ) %>%
  tidyr::pivot_longer(-group, names_to = "var", values_to = "per_match") %>%
  mutate(
    group = forcats::fct_reorder(group, rev(readr::parse_number(group))),
    var = factor(var, levels = names(comparables_small))
  ) %>%
ggplot() +
  geom_tile(aes(x = var, y = group, fill = per_match)) +
  geom_text(
    aes(
      x = var,
      y = group,
      label = scales::percent(per_match),
      color = per_match < 0.80
    ),
    alpha = 0.6
  ) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), position = "top") +
  scale_fill_distiller(
    name = "Percent of Characteristics from\nComparables which Match Target Property",
    direction = 1,
    labels = scales::percent,
    limits = c(0, 1)
  ) +
  scale_color_manual(
    values = c("TRUE" = "black", "FALSE" = "white"),
    guide = FALSE
  ) +
  labs(x = "", y = "") +
  guides(fill = guide_legend(title.position = "top")) +
  theme(
    legend.title = element_text(margin = margin(b = 6)),
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 0),
    axis.ticks = element_blank()
  )
```
</div>

<div id="tile2">
```{r, include=FALSE}
l <- 0.1
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Sales Comparables Characteristics $(l = `r l`)$

However, comparable properties should also have similar characteristics. The plot below shows the percent of characteristics from each comparables set that matches the target property. Darker values mean a high percentage of comparable characteristics match their target.

```{r tile2, echo=FALSE, out.width='100%', message=FALSE, ref.label="tile1"}
```
</div>

<button class=toggle_button onclick="plot_switch('tile1', 'tile2')">Toggle Distance Trade-Off Parameter Value</button>




<div id="table1">
```{r, include=FALSE}
l <- 0.9
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Characteristics Table $(l = `r l`)$

Each page of the table shown below shows a different set of comparables (5 sets in total), corresponding to the rows from the plot above. Switching between the two tables reveals that $l = 0.1$ yields much more physically similar properties. 

```{r table1, echo=FALSE, out.width='100%', cache=FALSE}
# Create a datatable object with rows k + 1
comparables_small %>%
  select(-median_sp, Group = group, Type = type, Price = price) %>%
  ccao::vars_rename(names_from = "socrata", names_to = "pretty") %>%
  select(-lon, -lat) %>%
  vars_recode(type = "short") %>%
  DT::datatable(
    rownames = FALSE,
    filter = "none",
    autoHideNavigation = TRUE,
    selection = "none",
    options = list(
      pageLength = 11,
      autoWidth = TRUE,
      scrollX = TRUE,
      searching = FALSE,
      info = FALSE
    )
  ) %>%
  DT::formatCurrency("Price", digits = 0) %>%
  DT::formatRound("Building Square Feet", digits = 0)
```
</div>

<div id="table2">
```{r, include=FALSE}
l <- 0.1
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Characteristics Table $(l = `r l`)$

Each page of the table shown below shows a different set of comparables (5 sets in total), corresponding to the rows from the plot above. Switching between the two tables reveals that $l = 0.1$ yields much more physically similar properties. 

```{r table2, echo=FALSE, out.width='100%', ref.label="table1"}
```
</div>

<button class=toggle_button onclick="plot_switch('table1', 'table2')">Toggle Distance Trade-Off Parameter Value</button>




<div id="dist1">
```{r, include=FALSE}
l <- 0.9
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Distributions of Sale Prices vs. Fair Market Value $(l = `r l`)$

Finally, good comparables will be close to each other in price. Here we show distributions of sale prices for each comparables set, along with the last assessed value for each target property. The resulting distributions are quite wide for some properties, however, our clustering was done using just 10 variables. Adding further variables or choosing a higher $m$ value will likely result in tighter distributions.

```{r dist1, echo=FALSE, out.width='100%', message=FALSE, warning=FALSE, cache=FALSE}
comparables_small %>%
  ggplot() +
  geom_histogram(aes(x = price, fill = type), binwidth = 5e4) +
  geom_vline(aes(xintercept = median_sp, color = "Median", linetype = "Median")) +
  scale_color_manual(name = "", values = c("Median" = "grey10")) +
  scale_linetype_manual(name = "", values = c("Median" = "dashed")) +
  scale_x_continuous(labels = scales::dollar) +
  scale_fill_manual(
    name = "Type",
    values = c("Comp" = "grey75", "Target" = "darkred")
  ) +
  facet_wrap(vars(group), ncol = 1, strip.position = "right") +
  labs(
    caption = "Target PIN price is most recent FMV",
    x = "Sale Price / FMV",
    y = "Count"
  ) +
  coord_cartesian(xlim = c(2.5e5, 1.5e6), ylim = c(0, 4)) +
  theme_minimal() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.spacing.y = unit(0.5, "cm"),
    axis.text.x = element_text(margin = margin(b = 10)),
    axis.text.y = element_text(margin = margin(l = 6))
  )
```
</div>

<div id="dist2">
```{r, include=FALSE}
l <- 0.1
```

```{r, include=FALSE, ref.label="find_comps", cache=FALSE}
```

#### Distributions of Sale Prices vs. Fair Market Value $(l = `r l`)$

Finally, good comparables will be close to each other in price. Here we show distributions of sale prices for each comparables set, along with the last assessed value for each target property. The resulting distributions are quite wide for some properties, however, our clustering was done using just 10 variables. Adding further variables or choosing a higher $m$ value will likely result in tighter distributions.

```{r dist2, echo=FALSE, out.width='100%', ref.label="dist1", message=FALSE, warning=FALSE}
```
</div>

<button class=toggle_button onclick="plot_switch('dist1', 'dist2')">Toggle Distance Trade-Off Parameter Value</button>
